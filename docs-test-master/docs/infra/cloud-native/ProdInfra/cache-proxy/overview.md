# Cache Proxy
![cache proxy](https://static.devfdg.net/static/mono-static/docs-ui/img/cache-proxy.png)
## Packages
### [logic](https://git.toolsfdg.net/mono/mono/tree/master/infra/pkg/cache-proxy/logic)
The logic package is the [logic layer](https://git.toolsfdg.net/mono/mono/tree/master/infra/pkg/cache-proxy/logic) of [master](https://git.toolsfdg.net/mono/mono/blob/master/infra/pkg/cache-proxy/logic/logic_master.go), [worker](https://git.toolsfdg.net/mono/mono/blob/master/infra/pkg/cache-proxy/logic/logic_worker.go), and [health check](https://git.toolsfdg.net/mono/mono/blob/master/infra/pkg/cache-proxy/logic/health.go).
### [logic/cacheRule](https://git.toolsfdg.net/mono/mono/tree/master/infra/pkg/cache-proxy/logic/cacheRule)
Preprocess and decide the cache how to store, which base on in-memory [Config](https://git.toolsfdg.net/mono/mono/blob/master/infra/pkg/cache-proxy/config/config.go#L22).
### [config](https://git.toolsfdg.net/mono/mono/tree/master/infra/pkg/cache-proxy/config)
According to the [cache-config.json](https://git.toolsfdg.net/mono/mono/blob/master/infra/pkg/cache-proxy/cache-config.json) and [rules](https://git.toolsfdg.net/mono/mono/blob/master/infra/pkg/cache-proxy/rules),
the config package populates the in-memory Config.
### [service](https://git.toolsfdg.net/mono/mono/tree/master/infra/pkg/cache-proxy/service)
The app layer, which encapsulates on the top of the [logic layer](https://git.toolsfdg.net/mono/mono/tree/master/infra/pkg/cache-proxy/logic), offers external APIs service.
### [dto](https://git.toolsfdg.net/mono/mono/tree/master/infra/pkg/cache-proxy/dto)
Define the request and response format in the microservice framework.
### [external](https://git.toolsfdg.net/mono/mono/tree/master/infra/pkg/cache-proxy/external)
The external package is a DB layer to encapsulate the Redis, SQS, and S3 libs.

## Others
### cache-config.json
This config file is from the CDN service so that cache proxy can take reference.
### rules
Define the preprocess of requests like valid header, cookie, and query string. Here is an
[example](https://git.toolsfdg.net/mono/mono/blob/master/infra/pkg/cache-proxy/rules)
and more descriptions. The rules is generated by operator with CRD. The example below is
how CRD look like and descriptions.
```yaml 
apiVersion: cache-proxy.binance.com/v1alpha1
kind: CacheRule
metadata:
  name: cacherule-sample
spec:
  hosts:
  - www.devfdg.net
  # Redirect
  rewrite:
  # Rules defines the URL path rewrite rules.
  - uri: "/old"
    to: "/new"
    # When there are repeated matched uri, larger weight is higher priority. 
    weight: 20
  # The values captured in asterisk can be retrieved by index e.g. $1, $2 and so on.
  - uri: "/en/orderbook/(.*)_(.*)"
    to: "/en/orderbook/$2_$1"
    weight: 15
  # Enumerate the corresponding uri to match the request
  # and verify the key-value of headers, cookies, and query string.
  enumerate:
  - uri: /en/orderbook/*
    # When there are repeated matched uri, larger weight is higher priority.
    weight: 10
    min_ttl: 120
    max_ttl: 120
    default_ttl: 120
    rules:
    # The key-value rule
    - type: querystring
      key: hello
      # Value rule can only use either enum or regex.
      value:
        # Here uses enum instead of regex.
        enum:
        - a
        - b
    - type: header
      key: clienttype
      value:
        enum:
        - pc
        - mobile
    - type: cookie
      key: p20t
      value:
        # Here uses regex instead of enum.
        regex: "user_*"
```

### PPT
https://docs.google.com/presentation/d/1GWGnoesvUYv3tXotIv0x-yJa6fMeV2T74TSqTk9De9w/edit?usp=sharing