---
id: x2c
title: X2C Research
hide_title: true
---

# Intro

X2C is the abbreviation for XML to Code. Avoid the comsumption of inflating layout in the runtime so that improve LCP.

![LayoutInflater Process](https://confluence.toolsfdg.net/download/attachments/66429379/LayoutInflater%20%281%29.png)

The more time-consuming parts of the entire inflate process are the IO and reflection processes. Android 10 newly introduces the preCompiled function, that is, during compilation, the layout is compiled into a separate dex file, and the class file generated by the reflector is used for inflate, and then the inflate method is called by reflection to directly return the View created by the code. Save the IO consumption of loading xml and the CPU consumption of parsing xml, so as to load the layout quickly. In principle, the X2C solution below Android 10 also saves the original IO and reflection time through the work of the compiler.

## Scheme

![X2C Scheme](https://confluence.toolsfdg.net/download/attachments/66429379/X2C.png)

There are 3 steps:

1. Annotate the layout of X2C and related classes in the coding stage through annotations.
2. In the compilation stage, the marked layout is generated through APT to generate corresponding code classes.
3. In the Transform phase, the Transform API is used to replace the inflate method of the class that needs to be replaced collected in step 2, and replaced with an X2C implementation.

After the above three steps are implemented, the function of X2C can be completed without affecting the daily development. The most important part is the second part, the process of generating X2C, because in order to avoid xml-related operations when inflate and reflection operations when instantiating View, it is necessary to parse XML at this time and support all attribute settings in the layout. All the construction process of View is translated to the compiler, which will be the most expensive part of maintenance.

## Testing

After all, there is still a relatively high maintenance cost, so in between, use the FutureTradeFragment page to verify the effect. That is, the code construction process of manually translating its layout.

### Attention

Some custom ViewGroup overrides the onInflateFinished method, and onMeasure depends on this method. If the onInflateFinished method is not called when manually constructing the View, its measure method will be invalid.

### Effect

Before X2C replacement, systrace was as follows:

![Before Replacement](https://confluence.toolsfdg.net/download/attachments/66429379/%E6%88%AA%E5%B1%8F2021-04-14%20%E4%B8%8B%E5%8D%882.05.57.png)

After X2C replacement, systrace was as follows:

![After Replacement](https://confluence.toolsfdg.net/download/attachments/66429379/%E6%88%AA%E5%B1%8F2021-04-14%20%E4%B8%8B%E5%8D%884.42.17.png)

572.861/1070 = 0.5353841121 ，inflate improve 12% ，LCP improve 5.6%.

## Conclusion

The overall improvement of LCP is not obvious, but the cost of maintaining X2C only brings less than 6% revenue. The ROI is too low, so the implementation of X2C scheme is not considered.